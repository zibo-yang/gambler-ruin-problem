<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Gambler_Ruin_Problem</title>
</head>


<body>
<div class="head">
<h1>Theory Gambler_Ruin_Problem</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Gambler_Ruin_Problem
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../AFP/DiscretePricing/Infinite_Coin_Toss_Space.html">DiscretePricing.Infinite_Coin_Toss_Space</a>

<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Gambler's ruin problem›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In Gamblerruin.thy, we will construct the formalization of a specific random walk model coordinated with gambler's ruin problem.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Theory Infinite{\_}Coin{\_}Toss{\_}Space›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In order to construct the formal method in gambler's ruin problem, we start with the existing 
formalization in the Theory Infinite{\_}Coin{\_}Toss{\_}Space which constructed the probability space 
on infinite sequences of independent coin.
tosses.›</span></span>



<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The only concept need to be elaborated is bernoulli. 'a stream is a type of infinite sequence with all 
element of type 'a. The bernoulli stream is a stream measure which has the space composed of all the 
elements of type bool stream, measurable sets filled with all the subset of its space. under this 
specific measure, all the possibility of occurrence of elements in a specific set A can be described 
as the measure value of A if and only if A is in the measurable sets of this bernoulli stream. In fact, 
it was set up by producting countable measure of boolean space with measuring \{True\} to p and \{False\} 
to $1-p$.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Gambler model›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> infinite_coin_toss_space<span class="main">)</span> <span class="entity">gambler_rand_walk_pre</span><span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> bool stream <span class="main">⇒</span> int<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gambler_rand_walk_pre</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span><span class="main">|</span>
  step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gambler_rand_walk_pre</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span>True <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">|</span> False <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">(</span>snth <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">gambler_rand_walk_pre</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> infinite_coin_toss_space<span class="main">)</span> <span class="entity">gambler_rand_walk</span><span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> <span class="main">(</span>enat <span class="main">⇒</span> bool stream <span class="main">⇒</span> int<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">gambler_rand_walk</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> enat <span class="bound">n</span> <span class="main">⇒</span> <span class="main">(</span>gambler_rand_walk_pre <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">|</span><span class="main">∞</span> <span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The function $gambler\_ran\_walk$ extends the fourth parameter by adding $\infty$ as new input.
The reason why we define it is that we found it very tough to describe the position where the specific
random walk stops, for the first time, by reaching the threshold if natural number is the only allowed 
input as what $gambler\_ran\_walk\_pre$ defines. Since some infinite random walks will never stop, 
we must allocate $\infty$ as the output coordinated with that non-stop case and extend the type of 
steps from \isa{nat} to \isa{enat}. But if someone wants to base their further analysis on our endeavor here, 
please be cautious of or even avoid discussing the case that initial number and target number is 
negative since we map $\infty$ to -1. The lemma $exist$ demonstrates that non-stop random walk will
never succeed in reaching the target, which is the best explanation why we allocates $-1$ as the output
of $\infty$ in $gambler\_ran\_walk$.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> gambler_model <span class="main">=</span> infinite_coin_toss_space <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">geom_proc</span><span class="main">::</span><span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool stream <span class="main">⇒</span> enat <span class="main">⇒</span> int"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> geometric_process<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="free">step</span> <span class="main">=</span> gambler_rand_walk <span class="main">1</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="free">step</span> <span class="free">x</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic functions›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we define the all basic functions which will play an invisible role in the further probability analysis.
you can just focus on the lemmas and functions where we comment›</span></span>
<span class="comment1">(*The first goal for us is to the conditional probability equation based on the specific identical
sets structure*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reach_steps</span><span class="main">::</span><span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool stream <span class="main">⇒</span> int <span class="main">⇒</span> nat set"</span></span><span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">reach_steps</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">target</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">step</span><span class="main">::</span>nat<span class="main">.</span> <span class="free">geom_proc</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">step</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">target</span></span></span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹$reach\_steps$ describes all the steps where the input random walk reaches the threshold {0, target}›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">infm</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">infm</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">∞</span> <span class="keyword1">else</span> <span class="main">⨅</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹infm A = {} iff A = {}›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> only_inf_infm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span><span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"infm <span class="free">A</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infm <span class="free">A</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∞</span> <span class="main">≤</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> infm.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_enat_eq enat_ord_simps not_infinity_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> l r <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> not_enat_eq enat_ord_simps not_infinity_eq
          assms equals0I 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stop_at</span><span class="main">::</span><span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool stream <span class="main">⇒</span> int <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">stop_at</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">target</span></span></span> <span class="main">=</span> <span class="main">(</span>infm <span class="main">(</span>reach_steps <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">target</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹$stop\_at$ describes the first step in the $reach\_steps$ sets, which means exactly the stopping point in
gambler's ruin problem. Be careful, Here the type of output has been extended to \isa{enat}, which means
stopping point will be $\infty$(equivalent to non-existence)›</span></span>



<span class="keyword1"><span class="command">fun</span></span> <span class="entity">success</span><span class="main">::</span><span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool stream <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span><span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">success</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">target</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">geom_proc</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>stop_at <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">target</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">target</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹success describes the random walk reaching the target number rather than ruining at stopping point›</span></span>


<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Important intermediate conclusions›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Successful random walks never stop at $\infty$›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Once we set target to be positive, the weird situation where random walk succeeds at $\infty$ will disappear›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span><span class="main">::</span><span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">target</span><span class="main">::</span><span class="quoted">int</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">init</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">≤</span> <span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> geometric_process <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The way we count never change the amount got through specific random walk›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> pre1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> snth <span class="bound">x</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> snth <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="bound">n</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> snth.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹lemma additional1 states that the reaching number doesn't change if we want to calculate from the second step›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> additional1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span> <span class="keyword1">in</span> 
<span class="free">geom_proc</span> <span class="bound">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>
    <span class="keyword1">in</span> <span class="free">geom_proc</span> <span class="bound">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>enat <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span> <span class="keyword1">in</span> 
         <span class="free">geom_proc</span> <span class="bound">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>enat <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="bound">init'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> geometric_process gambler_rand_walk.simps gambler_rand_walk_pre.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>
    <span class="keyword1">in</span> <span class="free">geom_proc</span> <span class="bound">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>enat <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def one_enat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> ams<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>
         <span class="keyword1">in</span> <span class="free">geom_proc</span> <span class="bound">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>enat <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
            <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ppp1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">init1</span> <span class="bound">x1</span> <span class="bound">n</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="bound">init1</span> <span class="bound">x1</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="bound">init1</span> <span class="bound">x1</span> <span class="bound">n</span> <span class="main">+</span> 
<span class="main">(</span><span class="keyword1">case</span> snth <span class="bound">x1</span> <span class="bound">n</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> geometric_process gambler_rand_walk.simps gambler_rand_walk_pre.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ams <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>
         <span class="keyword1">in</span> <span class="free">geom_proc</span> <span class="bound">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>enat <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> ppp1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> 
           ppp1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"stl <span class="free">x</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
           pre1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>

 <span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The way we count never change whether the random walk succeeds›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> set_up_Inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Inf <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> cInf_eq_minimum 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Inf_property<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> Inf <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"bdd_below <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bdd_below_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cInf_lower<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
 
  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹$conditional2\_pre$ states that stopping point doesn't change if we calculate from second step›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> conditional2_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Ar</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Al</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">Ar</span> <span class="main">=</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">Al</span> <span class="main">=</span> reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
        <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">" stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>

  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Ar</span><span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> ar_empty<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Ar</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">::</span>nat<span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> additional1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> al_empty<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Al</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init'</span></span> <span class="quoted"><span class="quoted">"stl <span class="free">x</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> al_empty <span class="keyword1"><span class="command">have</span></span> al_inf<span class="main">:</span><span class="quoted"><span class="quoted">"stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stop_at.simps assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ar_empty <span class="keyword1"><span class="command">have</span></span> ar_inf<span class="main">:</span><span class="quoted"><span class="quoted">"stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span> <span class="main">=</span> <span class="main">∞</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms stop_at.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> al_inf ar_inf <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> plus_enat_simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> ar_nonempty<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Ar</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> a_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> stop_at.simps 
      <span class="keyword1"><span class="command">using</span></span> only_inf_infm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Ar</span></span><span class="main">]</span> ar_nonempty assms<span class="main">(</span>2<span class="main">)</span> not_infinity_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"infm <span class="free">Ar</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_infinity_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a_def stop_at.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
              infm.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
              ar_nonempty
              assms<span class="main">(</span>2<span class="main">)</span>
              enat_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span><span class="main">]</span>
              enat.inject<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
              Inf_nat_def1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Ar</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">0</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> geometric_process<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> 
              gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">a</span> "</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute add.left_neutral add_Suc_right assms less_imp_Suc_add less_one not_less_eq not_less_less_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> reach_steps_def<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="skolem">a'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> additional1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">]</span> 
              a_def 
              stop_at.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span> 
              infm.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
              Inf_nat_def1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
              assms<span class="main">(</span>2<span class="main">)</span>
              ar_nonempty
              enat.inject<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
              reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mem_Collect_eq plus_1_eq_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>enat <span class="bound">xa</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">A</span><span class="main">::</span>nat set<span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> Inf <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> Inf <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_below <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bdd_below_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cInf_lower<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">A</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> Inf <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">⟹</span> <span class="skolem">a'</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> reach_steps_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>enat <span class="bound">xa</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span><span class="skolem">b</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> additional1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a_def 
              stop_at.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span> 
              infm.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
              <span class="quoted"><span class="quoted">‹<span class="free">Ar</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
              assms<span class="main">(</span>2<span class="main">)</span>
              enat.inject<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
              <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">A</span><span class="main">::</span>nat set<span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> Inf <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="main">⨅</span> <span class="main">(</span>reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_steps_def
      <span class="keyword1"><span class="command">using</span></span> cInf_eq_minimum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a'</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xa</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>enat <span class="bound">xa</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span><span class="main">}</span>"</span></span><span class="main">]</span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">∈</span> reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>›</span></span>
            reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init'</span></span> <span class="quoted"><span class="quoted">"stl <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> stop_at.simps
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> one_enat_def plus_enat_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹conditional2 states that whether a random walk succeeds or not doesn't change if we calculate from second step›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conditional2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">⟷</span> success <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ar</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ar</span> <span class="main">=</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">al</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">al</span> <span class="main">=</span> reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> lhs<span class="main">:</span><span class="quoted"><span class="quoted">"success <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lhs1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> success.simps 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init'</span></span> <span class="quoted"><span class="free">target</span></span> <span class="quoted"><span class="quoted">"stl <span class="free">x</span>"</span></span><span class="main">]</span> 
          success.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init'</span></span> <span class="quoted"><span class="quoted">"stl <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          assms
          geometric_process<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
          gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk_pre.simps
    <span class="keyword1"><span class="command">using</span></span> geometric_process <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_infinity_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> lhs1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conditional2_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ar</span></span> <span class="quoted"><span class="free">target</span></span> <span class="quoted"><span class="skolem">al</span></span><span class="main">]</span>
          assms
          <span class="quoted"><span class="quoted">‹<span class="skolem">ar</span> <span class="main">=</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">al</span> <span class="main">=</span> reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>›</span></span>
          additional1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 one_enat_def plus_enat_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> success.simps 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ar</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ar</span> <span class="main">=</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">al</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">al</span> <span class="main">=</span> reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> rhs<span class="main">:</span><span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rhs1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> success.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> 
          success.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          assms
          geometric_process<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
          gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk_pre.simps
    <span class="keyword1"><span class="command">using</span></span> geometric_process 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_infinity_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="skolem">a'</span> <span class="main">=</span> <span class="free">init</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹enat <span class="skolem">a'</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>›</span></span> add.commute add.right_neutral assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> conditional2_pre enat_add_left_cancel_less gr_implies_not_zero zero_enat_def zero_less_one<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> rhs1 
            assms
            <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">a'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 old.nat.exhaust<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rhs1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conditional2_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">ar</span></span> <span class="quoted"><span class="free">target</span></span> <span class="quoted"><span class="skolem">al</span></span><span class="main">]</span>
            assms
            <span class="quoted"><span class="quoted">‹<span class="skolem">ar</span> <span class="main">=</span> reach_steps <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">al</span> <span class="main">=</span> reach_steps <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a'</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">a'</span>›</span></span>
            eSuc_enat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 eSuc_inject plus_1_eSuc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> additional1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">a'</span>›</span></span> <span class="quoted"><span class="quoted">‹enat <span class="skolem">a'</span> <span class="main">=</span> stop_at <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>    
    <span class="keyword1"><span class="command">with</span></span> rhs1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="main">(</span>stop_at <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init'</span> <span class="main">(</span>stl <span class="free">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> success.simps 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The change of initial number›</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹if first step is true, then we add 1 to initial number›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> fst_true_plus_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>"</span></span><span class="quoted"><span class="quoted">"shd <span class="free">x</span> <span class="main">=</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">init'</span> <span class="main">=</span> <span class="free">init</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> int1<span class="main">:</span><span class="quoted"><span class="quoted">"gambler_rand_walk <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">1</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">0</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snth.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk_pre.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          one_enat_def zero_enat_def
          gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> int2<span class="main">:</span><span class="quoted"><span class="quoted">"gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">0</span> <span class="free">x</span> <span class="main">=</span> <span class="free">init</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> int3<span class="main">:</span><span class="quoted"><span class="quoted">"gambler_rand_walk <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">1</span> <span class="free">x</span> <span class="main">=</span> <span class="free">init'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> geometric_process<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
          assms<span class="main">(</span>1<span class="main">)</span>
          gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">init'</span> <span class="main">=</span> <span class="free">init</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> int1 int2 int3
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹if first step is False, then we reduce 1 to initial number›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> fst_true_plus_one_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">x</span> <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">1</span>"</span></span><span class="quoted"><span class="quoted">"shd <span class="free">x</span> <span class="main">=</span> False"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">init'</span> <span class="main">=</span> <span class="free">init</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> int1<span class="main">:</span><span class="quoted"><span class="quoted">"gambler_rand_walk <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">1</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">0</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snth.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk_pre.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          one_enat_def zero_enat_def
          gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> int2<span class="main">:</span><span class="quoted"><span class="quoted">"gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">0</span> <span class="free">x</span> <span class="main">=</span> <span class="free">init</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> int3<span class="main">:</span><span class="quoted"><span class="quoted">"gambler_rand_walk <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">1</span> <span class="free">x</span> <span class="main">=</span> <span class="free">init'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> geometric_process<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
          assms<span class="main">(</span>1<span class="main">)</span>
          gambler_rand_walk.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">init'</span> <span class="main">=</span> <span class="free">init</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> int1 int2 int3
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹The way we count never change the successful random walk set›</span></span> 
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹the set where all random walks in it succeeds and their first step are True doesn't change if 
we calculate from second step›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> conditional_set_equation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span>  <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">::</span>bool stream<span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span> <span class="main">=</span> 
 <span class="main">{</span><span class="bound">x</span><span class="main">::</span>bool stream<span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>
    <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">" shd <span class="skolem">x</span> <span class="main">=</span> True"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">init'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹shd <span class="skolem">x</span> <span class="main">=</span> True›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init'</span> <span class="main">=</span> <span class="free">init</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fst_true_plus_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
            assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="skolem">x</span> <span class="main">=</span> True"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conditional2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span> 
            assms
            <span class="quoted"><span class="quoted">‹<span class="skolem">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="main">1</span>›</span></span>
            <span class="quoted"><span class="quoted">‹shd <span class="skolem">x</span> <span class="main">=</span> True›</span></span>
            <span class="quoted"><span class="quoted">‹success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>
    <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span> <span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">"shd <span class="skolem">x</span> <span class="main">=</span> True"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">init'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹shd <span class="skolem">x</span> <span class="main">=</span> True›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init'</span> <span class="main">=</span> <span class="free">init</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fst_true_plus_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
            assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="skolem">x</span> <span class="main">=</span> True"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conditional2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span> 
            assms
            <span class="quoted"><span class="quoted">‹<span class="skolem">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="main">1</span>›</span></span>
            <span class="quoted"><span class="quoted">‹shd <span class="skolem">x</span> <span class="main">=</span> True›</span></span>
            <span class="quoted"><span class="quoted">‹success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span> <span class="free">target</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹the set where all random walks in it succeeds and their first step are False doesn't change if 
we calculate from second step›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> conditional_set_equation_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span>  <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span> 
          <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">::</span>bool stream<span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span> <span class="main">=</span> 
 <span class="main">{</span><span class="bound">x</span><span class="main">::</span>bool stream<span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>
    <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">" shd <span class="skolem">x</span> <span class="main">=</span> False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">init'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹shd <span class="skolem">x</span> <span class="main">=</span> False›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init'</span> <span class="main">=</span> <span class="free">init</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fst_true_plus_one_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
            assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="skolem">x</span> <span class="main">=</span>  False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conditional2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span> 
            assms
            <span class="quoted"><span class="quoted">‹<span class="skolem">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="main">1</span>›</span></span>
            <span class="quoted"><span class="quoted">‹shd <span class="skolem">x</span> <span class="main">=</span> False›</span></span>
            <span class="quoted"><span class="quoted">‹success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>
    <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span> <span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">"shd <span class="skolem">x</span> <span class="main">=</span> False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">init'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹shd <span class="skolem">x</span> <span class="main">=</span> False›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init'</span> <span class="main">=</span> <span class="free">init</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fst_true_plus_one_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
            assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="skolem">x</span> <span class="main">=</span> False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conditional2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init'</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span> 
            assms
            <span class="quoted"><span class="quoted">‹<span class="skolem">init'</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="main">1</span>›</span></span>
            <span class="quoted"><span class="quoted">‹shd <span class="skolem">x</span> <span class="main">=</span> False›</span></span>
            <span class="quoted"><span class="quoted">‹success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">x</span><span class="main">)</span> <span class="free">target</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Probability equation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we start to analyse the probability of successful random walk. To better understand this
part please have a look the elaboration in front of lemma $success\_measurable$›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹$probability\_of\_win$ is the function describing possibility of successful random walks with 
initial number and target number as inputs›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">probability_of_win</span><span class="main">::</span><span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> ennreal"</span></span><span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">probability_of_win</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">target</span></span></span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">target</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Successful random walk set is measurable›</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Preimage of function snth is measurable›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> snth_measurable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="free">M</span> <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> bernoulli  p_gt_0  p_lt_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bernoulli_stream_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> measurable_sets<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">k</span><span class="main">}</span>"</span></span><span class="main">]</span>
          bernoulli_stream_preimage<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">k</span><span class="main">}</span>"</span></span><span class="main">]</span>
          bernoulli
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> stake_measurable_pre1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">w</span> <span class="free">k</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">k</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">k</span> <span class="main">⟷</span> stake <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">k</span> <span class="main">∧</span> snth <span class="free">w</span> <span class="free">n</span> <span class="main">=</span> nth <span class="free">k</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">k</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">!!</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_hd_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
          stake_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
          assms
          append_eq_append_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">k</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>snth <span class="free">w</span> <span class="free">n</span><span class="main">]</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>nth <span class="free">k</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="main">]</span>
          length_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
          length_stake<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
          Lattices.linorder_class.min.absorb_iff2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"length <span class="free">k</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append1_eq_conv hd_drop_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="free">w</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">k</span> <span class="main">∧</span> snth <span class="free">w</span> <span class="free">n</span> <span class="main">=</span> nth <span class="free">k</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_hd_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
          stake_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
          assms
          append_eq_append_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">k</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>snth <span class="free">w</span> <span class="free">n</span><span class="main">]</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">[</span>nth <span class="free">k</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="main">]</span>
          length_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
          length_stake<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
          Lattices.linorder_class.min.absorb_iff2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"length <span class="free">k</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> take_Suc_conv_app_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> stake_measurable_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> length <span class="bound">k</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span>stake <span class="free">n</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="main">0</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">.</span> stake <span class="main">0</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="main">0</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> space <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
              bernoulli
              <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="main">0</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">list</span>
      <span class="keyword3"><span class="command">assume</span></span><span class="quoted"><span class="quoted">" <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">#</span> <span class="skolem">list</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">w</span><span class="main">.</span> stake <span class="main">0</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="main">0</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="main">0</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k1</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">≤</span> length <span class="bound">k1</span> <span class="main">⟹</span> <span class="main">(</span>stake <span class="skolem">n</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">k1</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">k</span> <span class="main">⟹</span> stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∈</span> events"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">k</span>"</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>stake <span class="skolem">n</span> <span class="main">-`</span> <span class="main">{</span>take <span class="skolem">n</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>nth <span class="skolem">k</span> <span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span><span class="main">}</span>
      <span class="main">⊆</span> stake <span class="skolem">n</span> <span class="main">-`</span> <span class="main">{</span>take <span class="skolem">n</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">!!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="skolem">n</span> <span class="skolem">w</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stake_measurable_pre1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span>
                  <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">k</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snth <span class="skolem">w</span> <span class="skolem">n</span> <span class="main">=</span> nth <span class="skolem">k</span> <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stake_measurable_pre1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span>
                  <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">k</span>›</span></span>
                  <span class="quoted"><span class="quoted">‹stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">(</span>stake <span class="skolem">n</span> <span class="main">-`</span> <span class="main">{</span>take <span class="skolem">n</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>nth <span class="skolem">k</span> <span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹snth <span class="skolem">w</span> <span class="skolem">n</span> <span class="main">=</span> nth <span class="skolem">k</span> <span class="skolem">n</span>›</span></span>
                  <span class="quoted"><span class="quoted">‹stake <span class="skolem">n</span> <span class="skolem">w</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="skolem">k</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="skolem">n</span> <span class="main">-`</span> <span class="main">{</span>take <span class="skolem">n</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">!!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">}</span>
      <span class="main">⊆</span> stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">(</span>stake <span class="skolem">n</span> <span class="main">-`</span> <span class="main">{</span>take <span class="skolem">n</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>nth <span class="skolem">k</span> <span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snth <span class="skolem">w</span> <span class="skolem">n</span> <span class="main">=</span> nth <span class="skolem">k</span> <span class="skolem">n</span>"</span></span><span class="quoted"><span class="quoted">"stake <span class="skolem">n</span> <span class="skolem">w</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stake_measurable_pre1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span>
                  <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">k</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> take_all<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span>
             <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">k</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="skolem">n</span> <span class="main">-`</span> <span class="main">{</span>take <span class="skolem">n</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">k1</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">≤</span> length <span class="bound">k1</span> <span class="main">⟹</span> <span class="main">(</span>stake <span class="skolem">n</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">k1</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>›</span></span>
              <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">k</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> snth <span class="bound">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>nth <span class="skolem">k</span> <span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span> "</span></span>
        <span class="keyword1"><span class="command">using</span></span> snth_measurable
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∈</span> events"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≤</span> length <span class="skolem">k</span>"</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≠</span> length <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k1</span> <span class="main">.</span> length <span class="bound">k1</span> <span class="main">&lt;</span> length <span class="skolem">k</span> <span class="main">⟹</span> <span class="bound">k1</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="bound">w</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> length_stake<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
                <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">k</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∈</span> events"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The preimage of any list over function stake is measurable›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stake_measurable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">k</span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="free">n</span> <span class="main">-`</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="free">k</span> <span class="main">≥</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">k</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="free">n</span> <span class="main">-`</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stake_measurable_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">n</span> <span class="main">≤</span> length <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="main">-`</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k1</span> <span class="main">.</span> length <span class="bound">k1</span> <span class="main">&gt;</span> length <span class="free">k</span> <span class="main">⟹</span> <span class="bound">k1</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> stake <span class="free">n</span> <span class="bound">w</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_stake<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span>  <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
              <span class="quoted"><span class="quoted">‹length <span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="main">-`</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="free">n</span> <span class="main">-`</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> UN_empty2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The preimage of any list set over function stake is measurable once the set is finite›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> finite_stake_measurable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span><span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="free">n</span> <span class="main">-`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span>stake <span class="free">n</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>stake <span class="free">n</span> <span class="main">-`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stake <span class="free">n</span> <span class="main">-`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stake_measurable
          assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sets.finite_UN<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The new $geom\_proc$ function for list›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">geom_proc_list</span><span class="main">::</span><span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool list <span class="main">⇒</span> int"</span></span><span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">geom_proc_list</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span>"</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">geom_proc_list</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> True<span class="main">⇒</span><span class="main">1</span><span class="main">|</span>False <span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">geom_proc_list</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> reverse_construct_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">lengthx</span> <span class="free">y</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span>bool list<span class="main">.</span> <span class="free">lengthx</span> <span class="main">=</span> length <span class="bound">x</span> <span class="main">⟹</span>  geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True<span class="main">⇒</span><span class="main">1</span><span class="main">|</span>False<span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">lengthx</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">=</span> length <span class="bound">x</span> <span class="main">⟹</span>
         geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="bound">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
         geom_proc_list <span class="free">init</span> <span class="bound">x</span> <span class="main">+</span>
         <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">lengthx</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span><span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="skolem">lengthx</span> <span class="main">=</span> length <span class="bound">x1</span> <span class="main">⟹</span>
           geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="bound">x1</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
           geom_proc_list <span class="free">init</span> <span class="bound">x1</span> <span class="main">+</span>
           <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">lengthx</span> <span class="main">=</span> length <span class="skolem">x</span> <span class="main">⟹</span>
          geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
          geom_proc_list <span class="free">init</span> <span class="skolem">x</span> <span class="main">+</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">lengthx</span> <span class="main">=</span> length <span class="skolem">x</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="skolem">lengthx</span> <span class="main">=</span> length <span class="bound">x1</span> <span class="main">⟹</span>
           geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="bound">x1</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
           geom_proc_list <span class="free">init</span> <span class="bound">x1</span> <span class="main">+</span>
           <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="main">(</span>hd <span class="skolem">x</span> <span class="main">#</span> <span class="main">(</span>tl <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> Nil_is_append_conv <span class="quoted"><span class="quoted">‹Suc <span class="skolem">lengthx</span> <span class="main">=</span> length <span class="skolem">x</span>›</span></span> hd_Cons_tl hd_append2 length_Suc_conv list.discI tl_append2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>hd <span class="skolem">x</span> <span class="main">#</span> <span class="main">(</span>tl <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> hd <span class="skolem">x</span> <span class="keyword1">of</span> True<span class="main">⇒</span><span class="main">1</span><span class="main">|</span>False<span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> geom_proc_list <span class="free">init</span> <span class="main">(</span>tl <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> geom_proc_list.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>tl <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="main">(</span>tl <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span>
           <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">lengthx</span> <span class="main">=</span> length <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="skolem">lengthx</span> <span class="main">=</span> length <span class="bound">x1</span> <span class="main">⟹</span> geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="bound">x1</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="bound">x1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>tl <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">case</span> hd <span class="skolem">x</span> <span class="keyword1">of</span> True<span class="main">⇒</span><span class="main">1</span><span class="main">|</span>False<span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">lengthx</span> <span class="main">=</span> length <span class="skolem">x</span>›</span></span> add.commute geom_proc_list.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_Cons_tl length_Suc_conv list.discI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
          geom_proc_list <span class="free">init</span> <span class="skolem">x</span> <span class="main">+</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reverse_construct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">x</span> <span class="free">y</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span><span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> True<span class="main">⇒</span><span class="main">1</span><span class="main">|</span>False<span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reverse_construct_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> success_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">x</span> <span class="free">target</span> <span class="free">i</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="main">0</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>enat <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stake.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          geom_proc_list.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span><span class="main">]</span>
          geometric_process<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">0</span>"</span></span><span class="main">]</span>
          gambler_rand_walk.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">0</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          enat_0
          enat.simps<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="bound">n</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="skolem">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="skolem">i</span> <span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stake_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="skolem">i</span> <span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">]</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="skolem">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="keyword1">of</span> True<span class="main">⇒</span><span class="main">1</span><span class="main">|</span>False<span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reverse_construct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="quoted">"stake <span class="skolem">i</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="skolem">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="skolem">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="skolem">i</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="keyword1">of</span> True<span class="main">⇒</span><span class="main">1</span><span class="main">|</span>False<span class="main">⇒</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> geometric_process
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Any natural number smaller than Inf A doesn't belong to A›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> not_belong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="free">A</span> <span class="main">&gt;</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="main">⨅</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inf_property<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This is the most important intermediate lemma prepared for lemma $success\_measurable. It clarifies
that any list in the image of successful random walk over function stake will never contain another 
shorter list corresponding to another successful random walk$›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> success_measurable2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">i</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> stop_at <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> <span class="free">i</span><span class="main">}</span>
<span class="main">=</span> stake <span class="free">i</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span>geom_proc_list <span class="free">init</span> <span class="main">(</span>take <span class="bound">k</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span><span class="main">)</span><span class="main">∧</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> geom_proc_list <span class="free">init</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">target</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">∧</span> stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">i</span><span class="main">}</span>
    <span class="main">⊆</span> stake <span class="free">i</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">target</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">∧</span> stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lhs1<span class="main">:</span><span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> lhs2<span class="main">:</span><span class="quoted"><span class="quoted">"stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="free">i</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> success_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
            assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> lhs2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> take <span class="bound">k</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> stake <span class="bound">k</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> take_stake
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_stake min.strict_order_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="bound">k</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> success_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
            assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> nonempty<span class="main">:</span><span class="quoted"><span class="quoted">"reach_steps <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="skolem">x</span>
       <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="free">i</span> <span class="main">=</span> <span class="free">target</span>›</span></span>
            reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="bound">k</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lhs2 stop_at.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
            infm.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
            not_belong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
            reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enat.inject mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="bound">k</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="bound">k</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>length_stake<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> stake <span class="free">i</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">target</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>›</span></span>
          <span class="quoted"><span class="quoted">‹geom_proc_list <span class="free">init</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">target</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">i</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">target</span><span class="main">}</span>
    <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">∧</span> stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> stake <span class="free">i</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">target</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rhs1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">k</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> 
                rhs2<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
                rhs3<span class="main">:</span><span class="quoted"><span class="quoted">"geom_proc_list <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="main">(</span>stake <span class="free">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">target</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> rhs3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="free">i</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> success_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> reach_steps_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> rhs1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="bound">k</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> success_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
              assms
              take_stake<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
              min.strict_order_iff<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">=</span> Inf <span class="main">(</span>reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span><span class="main">)</span> "</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
                stop_at.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
                infm.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="free">i</span> <span class="main">=</span> <span class="free">target</span>›</span></span>
                reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∉</span> reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="bound">k</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span>›</span></span>
                reach_steps_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span>reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span>  
                <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∈</span> reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>›</span></span>
                <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∉</span> reach_steps <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_refl nat_less_le nat_neq_iff set_up_Inf<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span> <span class="free">target</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> success.simps
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">geom_proc</span> <span class="free">init</span> <span class="skolem">x</span> <span class="free">i</span> <span class="main">=</span> <span class="free">target</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">::</span>bool stream<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
              bernoulli 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>       
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">∧</span> stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹stop_at <span class="main">(</span><span class="free">init</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">target</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">i</span>›</span></span>
              <span class="quoted"><span class="quoted">‹success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stake_space<span class="main">:</span><span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="main">`</span> space <span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">" stake <span class="free">n</span> <span class="main">`</span> space <span class="free">M</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">x</span> <span class="main">∈</span> stake <span class="free">n</span> <span class="main">`</span> space <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_stake
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span> <span class="main">⊆</span> stake <span class="free">n</span> <span class="main">`</span> space <span class="free">M</span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"shd <span class="skolem">k</span> <span class="main">=</span> True"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="keyword2"><span class="keyword">where</span></span><span class="quoted"><span class="quoted">"<span class="skolem">k1</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">@-</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="skolem">k1</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stake_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
      <span class="quoted"><span class="quoted">‹length <span class="skolem">x</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
      take_all<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
      stake.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="skolem">k2</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_stake<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="main">_</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k2</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bernoulli
            bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>stake <span class="free">n</span> <span class="main">`</span> space <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹stake <span class="free">n</span> <span class="skolem">k2</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Set of all the lists with specific length is finite›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> finite_length<span class="main">:</span><span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span>bool set"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?U</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>stake <span class="free">n</span> <span class="main">`</span>streams <span class="var">?U</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> stake_finite_universe_finite<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="main">`</span> streams <span class="var">?U</span> <span class="main">=</span> stake <span class="free">n</span> <span class="main">`</span> space <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bernoulli
          bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="free">n</span> <span class="main">`</span> streams <span class="var">?U</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stake_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>stake <span class="free">n</span> <span class="main">`</span>streams <span class="var">?U</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> finite_image<span class="main">:</span><span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">c</span><span class="main">::</span>bool list<span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span>geom_proc_list <span class="free">init</span> <span class="main">(</span>take <span class="bound">k</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">target</span><span class="main">}</span><span class="main">)</span><span class="main">∧</span> length <span class="bound">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> geom_proc_list <span class="free">init</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">target</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Sets of all successful random walk with specific stop is measurable›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> success_measurable3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="free">target</span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="free">i</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">&lt;</span><span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> stop_at <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> enat <span class="free">i</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
success_measurable2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
finite_stake_measurable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span>
             geom_proc_list <span class="free">init</span> <span class="main">(</span>take <span class="bound">k</span> <span class="bound">c</span><span class="main">)</span>
             <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">target</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
         length <span class="bound">c</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> geom_proc_list <span class="free">init</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">target</span><span class="main">}</span>"</span></span><span class="main">]</span>
assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Any successful random walk must stop at specific position described by natural number›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> success_measurable1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> 
<span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> stop_at <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">∧</span> stop_at <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">=</span> enat <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> success.simps
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> exist 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"stop_at <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span> <span class="main">=</span> enat <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">∧</span> stop_at <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">=</span> enat <span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>›</span></span>
            bernoulli
            bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span>
           success <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">∧</span> stop_at <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">=</span> enat <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">∧</span> stop_at <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">=</span> enat <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">xa</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span>
                    success <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">∧</span>
                    stop_at <span class="free">init</span> <span class="bound">xa</span> <span class="free">target</span> <span class="main">=</span> enat <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="free">init</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bernoulli
            bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Here we need to elaborate about this most difficult lemma we've met during this model 
formalization. lemma $success\_measurable$ asserts that successful random walks set under assumption
"$0 \leq initial number \leq target number$" is measurable set for measure M. On the one hand, since the 
probability theory has been set up based on the measure theory, every specific set must be proved to
be measurable with respect to fixed measure before we calculate the probability of the set, which
severely hinders most of scholars and experts from formalizing the security analysis related to the 
probability since it's extremely difficult to prove why your set is measurable. That is exactly why 
our endeavor matters to provide the first example to overcome the difficulty. On the other hand, we 
are willing to briefly explain the way we prove this lemma since it's nontrivial even for pen-and-paper
proof. lemma $finite\_stake\_measurable$ states that for the function ($\lambda$w. stake n w) taking the first n 
steps of random walk, the preimage of a finite sets is measurable for measure M. lemma $finite\_image$ 
states that sets filled with all bool list of fixed length n is finite. lemma $success\_measurable2$ sets
up the bijection between successful random walks stopping at fixed step and preimage of successful bool
list with identical length. lemma $success\_measurable1$ demonstrates that set of successful random
walks is countable union of sets of successful random walks stopping at some step. Combining theses 4 
lemmas together proves the set of successful random walk is measurable. If you take a closed look at 
the proofs of these 4 lemmas patiently, you will find it's very hard to finish. Honestly, we will 
never be able to finish such difficult proofs within one month without the current stochastic process
theory library established just in 2021 by Mnacho Echenim, the author of theory $infinite\_coin\_toss\_space$.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> success_measurable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">≤</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">=</span> <span class="free">target</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> equ<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">0</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enat_0 gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="main">_</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> geometric_process gambler_rand_walk.simps gambler_rand_walk_pre.simps
    <span class="keyword1"><span class="command">using</span></span> enat_0 gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="main">_</span><span class="main">]</span> 
          enat.simps<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="bound">n</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> belong_0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">∈</span> reach_steps <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_steps_def geometric_process gambler_rand_walk.simps gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> equ 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⨅</span> reach_steps <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_belong 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> stop_at <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stop_at.simps infm.simps
    <span class="keyword1"><span class="command">using</span></span> belong_0 enat_0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> stop_at <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> bernoulli
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> success.simps
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="free">target</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Collect_cong Collect_mem_eq sets.top<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">≠</span> <span class="free">target</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> equ1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="main">0</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> enat_0 gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="main">_</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> geometric_process gambler_rand_walk.simps gambler_rand_walk_pre.simps
        <span class="keyword1"><span class="command">using</span></span> enat_0 gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="free">init</span></span> <span class="main">_</span><span class="main">]</span> 
              enat.simps<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> gambler_rand_walk_pre <span class="main">1</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">init</span> <span class="bound">n</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> belong_0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">∈</span> reach_steps <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> reach_steps_def geometric_process gambler_rand_walk.simps gambler_rand_walk_pre.simps<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> equ1
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⨅</span> reach_steps <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_belong 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> stop_at <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> stop_at.simps infm.simps
        <span class="keyword1"><span class="command">using</span></span> belong_0 enat_0
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> stop<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> stop_at <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> bernoulli
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span>"</span></span><span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> success.simps
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
             that
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span>"</span></span><span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> success.simps
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">geom_proc</span> <span class="free">init</span> <span class="bound">x</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
             that
             stop
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">target</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_empty_eq <span class="quoted"><span class="quoted">‹<span class="free">init</span> <span class="main">≠</span> <span class="free">target</span>›</span></span> equ1 sets.empty_sets<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">≠</span><span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span><span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span><span class="main">&lt;</span><span class="free">target</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">init</span> <span class="main">≠</span> <span class="free">target</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> success_measurable1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="main">]</span>
              success_measurable3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="main">_</span><span class="main">]</span>
              assms
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The set of all the random walk with first step True is measurable›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> success_measurable_shd<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> snth_measurable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted">True</span><span class="main">]</span>
        snth.simps<span class="main">(</span>1<span class="main">)</span>
        bernoulli
        bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_compr streams_UNIV<span class="main">)</span>


  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The set of all the random walk with first step False is measurable›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> success_measurable_shd_false<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> success_measurable_shd 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">lemma</span></span> success_measurable_final<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conditional_set_equation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          assms
          bernoulli
          bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span> <span class="main">=</span> True<span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Sigma_Algebra.sets.Int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> shd <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span><span class="main">]</span>
          success_measurable_shd
          success_measurable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Probability of successful random walk with its first step True›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> semi_goal1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span> <span class="free">P</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">≤</span> <span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">=</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> 
<span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span>False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> True"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> shd <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> stream.sel<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="main">_</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> shd <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> True›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>shd <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> False›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> semi_goal21<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="free">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> ennreal <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_function <span class="free">m</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simple_function_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span> <span class="main">∈</span> sets <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span>False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>›</span></span><span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span> ennreal_0 insert_absorb2 sets.top singletonD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>  <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> semi_goal21_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="free">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> ennreal <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simple_function <span class="free">m</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simple_function_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span> <span class="main">∈</span> sets <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span>False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>›</span></span><span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span> ennreal_0 insert_absorb2 sets.top singletonD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>  <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> sum_rephrase<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"ennreal <span class="main">⇒</span> ennreal"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">e</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span> <span class="main">+</span> <span class="free">f</span> <span class="main">(</span><span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite.insertI insert_absorb insert_not_empty singleton_insert_inj_eq' sum_clauses<span class="main">(</span>1<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> semi_goal22<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="free">e</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="free">p1</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">p1</span><span class="main">≤</span><span class="main">1</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> ennreal <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>S</sup></span> <span class="free">m</span> <span class="free">f</span> <span class="main">=</span> <span class="free">p1</span> <span class="main">*</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simple_integral_def
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="free">p1</span> <span class="main">*</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>  <span class="main">=</span> <span class="main">{</span>False<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
               <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
                ennreal_eq_0_iff
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>False<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>False<span class="main">}</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>False<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> False"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">m</span> <span class="main">(</span><span class="main">{</span>False<span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> emeasure_pmf_single ennreal_cong
      <span class="keyword1"><span class="command">using</span></span> pmf_bernoulli_False<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span><span class="main">]</span>
            assms<span class="main">(</span>2<span class="main">)</span> 
            assms<span class="main">(</span>3<span class="main">)</span> 
            ennreal_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">p1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>False<span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> True"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
                 <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
                  ennreal_eq_0_iff
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> mult_zero_right<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>True<span class="main">}</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">m</span> <span class="main">(</span><span class="main">{</span>True<span class="main">}</span><span class="main">)</span> <span class="main">=</span>  <span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> emeasure_pmf_single ennreal_cong
      <span class="keyword1"><span class="command">using</span></span> pmf_bernoulli_False<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span><span class="main">]</span>
            assms<span class="main">(</span>2<span class="main">)</span> 
            assms<span class="main">(</span>3<span class="main">)</span> 
            ennreal_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">p1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> ennreal <span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span>False<span class="main">}</span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span><span class="main">)</span>
<span class="main">=</span> <span class="main">0</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">+</span> ennreal <span class="free">e</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_rephrase<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ennreal <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span>"</span></span><span class="main">]</span> 
            ennreal_eq_0_iff
            <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 
        <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span>False<span class="main">}</span>›</span></span>
        <span class="quoted"><span class="quoted">‹emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">p1</span>›</span></span>
        <span class="quoted"><span class="quoted">‹emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.left_neutral assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ennreal_mult'' mult.commute mult_zero_left<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> semi_goal22_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="free">e</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">≤</span><span class="free">p1</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">p1</span><span class="main">≤</span><span class="main">1</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> ennreal <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>S</sup></span> <span class="free">m</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p1</span><span class="main">)</span> <span class="main">*</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simple_integral_def
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p1</span><span class="main">)</span> <span class="main">*</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>  <span class="main">=</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> True"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
               <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
                ennreal_eq_0_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> mult.right_neutral<span class="main">)</span>       
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>True<span class="main">}</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>True<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> True"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">m</span> <span class="main">(</span><span class="main">{</span>True<span class="main">}</span><span class="main">)</span> <span class="main">=</span>  <span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> emeasure_pmf_single ennreal_cong
      <span class="keyword1"><span class="command">using</span></span> pmf_bernoulli_False<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span><span class="main">]</span>
            assms<span class="main">(</span>2<span class="main">)</span> 
            assms<span class="main">(</span>3<span class="main">)</span> 
            ennreal_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">p1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>False<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span>False<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 
                 <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
                  ennreal_eq_0_iff
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> mult_zero_right<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>False<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>False<span class="main">}</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">m</span> <span class="main">(</span><span class="main">{</span>False<span class="main">}</span><span class="main">)</span> <span class="main">=</span>  <span class="main">1</span><span class="main">-</span><span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> emeasure_pmf_single ennreal_cong
      <span class="keyword1"><span class="command">using</span></span> pmf_bernoulli_False<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span><span class="main">]</span>
            assms<span class="main">(</span>2<span class="main">)</span> 
            assms<span class="main">(</span>3<span class="main">)</span> 
            ennreal_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">p1</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">-</span> <span class="free">p1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>False<span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span> False<span class="main">}</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> ennreal <span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span>False<span class="main">}</span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span> <span class="main">`</span> space <span class="free">m</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span><span class="main">)</span>
<span class="main">=</span> <span class="main">0</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">+</span> ennreal <span class="free">e</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_rephrase<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ennreal <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span>"</span></span><span class="main">]</span> 
            ennreal_eq_0_iff
            <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="free">e</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p1</span><span class="main">)</span> <span class="main">+</span> <span class="main">0</span> <span class="main">*</span> ennreal <span class="free">p1</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p1</span><span class="main">)</span><span class="main">*</span><span class="free">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> ennreal_mult' mult.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 
        <span class="quoted"><span class="quoted">‹space <span class="free">m</span> <span class="main">=</span> <span class="main">{</span>True<span class="main">,</span>False<span class="main">}</span>›</span></span>
        <span class="quoted"><span class="quoted">‹emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span>ennreal <span class="free">e</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p1</span>›</span></span>
        <span class="quoted"><span class="quoted">‹emeasure <span class="free">m</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> space <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">p1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

 <span class="keyword1"><span class="command">lemma</span></span> semi_goal23<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="free">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> ennreal <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span> <span class="main">=</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>S</sup></span> <span class="free">m</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nn_integral_eq_simple_integral semi_goal21<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">p1</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> semi_goal23_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="free">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> ennreal <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span> <span class="main">=</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>S</sup></span> <span class="free">m</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nn_integral_eq_simple_integral semi_goal21_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">p1</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">lemma</span></span> semi_goal2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="free">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> ennreal <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span> <span class="main">=</span> <span class="free">p1</span> <span class="main">*</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> nn_integral_const<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> semi_goal22<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span> semi_goal23<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>          
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> semi_goal2_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span> <span class="free">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> ennreal <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p1</span><span class="main">)</span> <span class="main">*</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> nn_integral_const<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> semi_goal22_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span> semi_goal23_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>          
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> semi_goal2_final<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">ennreal</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> top"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span> <span class="main">=</span> <span class="free">p1</span> <span class="main">*</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span><span class="main">≥</span><span class="main">0</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="skolem">e1</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ennreal_cases<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e1</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> ennreal <span class="main">(</span><span class="skolem">f1</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹ennreal <span class="skolem">e1</span> <span class="main">=</span> <span class="free">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e1</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ennreal <span class="skolem">e1</span> <span class="main">=</span> <span class="free">e</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> ennreal_0 mult.right_neutral mult_cancel_left1 mult_cancel_right1 mult_zero_right<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f1</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms semi_goal2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="skolem">e1</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span><span class="main">≥</span><span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e1</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>›</span></span>
         <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> ennreal <span class="main">(</span><span class="skolem">f1</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">t</span>›</span></span> <span class="quoted"><span class="quoted">‹ennreal <span class="skolem">e1</span> <span class="main">=</span> <span class="free">e</span>›</span></span> ennreal_mult'' 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> semi_goal2_final_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p1</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">ennreal</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">p1</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> top"</span></span>
<span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p1</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span> <span class="main">=</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p1</span><span class="main">)</span> <span class="main">*</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span><span class="main">≥</span><span class="main">0</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ennreal <span class="skolem">e1</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ennreal_cases<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e1</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> ennreal <span class="main">(</span><span class="skolem">f1</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="quoted"><span class="quoted">‹ennreal <span class="skolem">e1</span> <span class="main">=</span> <span class="free">e</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e1</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ennreal <span class="skolem">e1</span> <span class="main">=</span> <span class="free">e</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> ennreal_0 mult.right_neutral mult_cancel_left1 mult_cancel_right1 mult_zero_right<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f1</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∂</span><span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms semi_goal2_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p1</span></span> <span class="quoted"><span class="skolem">e1</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="skolem">f1</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span><span class="main">≥</span><span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">f1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e1</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>›</span></span>
         <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> ennreal <span class="main">(</span><span class="skolem">f1</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">t</span>›</span></span> <span class="quoted"><span class="quoted">‹ennreal <span class="skolem">e1</span> <span class="main">=</span> <span class="free">e</span>›</span></span> ennreal_mult'' 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">lemma</span></span> fun_description_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> 
<span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span><span class="main">|</span>False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="free">target</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> True"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span>  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> True"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> "</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> that
                  stream.sel<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
                  bernoulli
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span><span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stream_space_Stream
          <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>›</span></span>
                    stream_space_Stream<span class="main">[</span><span class="operator">of</span>  <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
                    bernoulli
                    bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> bernoulli
                      bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
                      that
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">"shd <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stream.sel<span class="main">(</span>2<span class="main">)</span> stream.sel<span class="main">(</span>1<span class="main">)</span> that
                  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>›</span></span>
                  <span class="quoted"><span class="quoted">‹success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="free">target</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> that
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
                  bernoulli
                  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> True›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> True›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> True›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> False"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span>  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∉</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> stream.sel<span class="main">(</span>1<span class="main">)</span> that
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> False›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_description_pre_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
<span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> 
<span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span><span class="main">|</span>False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="free">target</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> False"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span>  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> "</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">)</span> <span class="free">target</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> that
                  stream.sel<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
                  bernoulli
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> 
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span><span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="free">target</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stream_space_Stream
          <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>›</span></span>
                    stream_space_Stream<span class="main">[</span><span class="operator">of</span>  <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
                    bernoulli
                    bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> bernoulli
                      bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
                      that
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">target</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">¬</span> shd <span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="free">M</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stream.sel<span class="main">(</span>2<span class="main">)</span> stream.sel<span class="main">(</span>1<span class="main">)</span> that
                  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>›</span></span>
                  <span class="quoted"><span class="quoted">‹success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="free">target</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">##</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> that
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
                  bernoulli
                  <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> space <span class="free">M</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> False›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> False›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> False›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> True"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span>  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> True"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∉</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> stream.sel<span class="main">(</span>1<span class="main">)</span> that
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="free">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> True›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">term</span></span><span class="quoted"><span class="quoted">"<span class="free">emeasure_stream_space</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The lemma $semi\_goal\_true$ is the second difficulty we've overcome during the model formalization.
It asserts that probability of sets of successful random walk with first step True is equal to 
probability of sets of random walk times probability of sets of successful random walk with initial
number plus 1. Thanks to the lemma $emeasure\_stream\_space$ provided by Mnacho Echenim, the author of 
$infinite\_coin\_toss\_space$, we could finally use the integral rather than tediously break down the 
countable product to calculate the probability›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> semi_goal_true<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span> 
<span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">*</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="free">target</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> sets <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="main">⟹</span>
  emeasure <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> emeasure <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span> <span class="main">∂</span><span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emeasure_stream_space
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Collect_cong nn_integral_cong prob_space.emeasure_stream_space prob_space_measure_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> success_measurable_final<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span> assms
          bernoulli
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bernoulli_stream_def<span class="main">)</span>    
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="bound">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span>
       <span class="main">∂</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
    ennreal <span class="free">p</span> <span class="main">*</span> emeasure <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">≠</span> top"</span></span>
        <span class="keyword1"><span class="command">using</span></span> emeasure_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
              success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span><span class="main">]</span>
              bernoulli
              bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="bound">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span>
          emeasure <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">*</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fun_description_pre<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="main">_</span><span class="main">]</span> assms
              bernoulli
              bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
              mult.commute 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> semi_goal2_final<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> 
<span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="free">target</span><span class="main">}</span>"</span></span> 
<span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="bound">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span>"</span></span><span class="main">]</span>   
            p_gt_0 p_lt_1
            bernoulli
            bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span> 
<span class="main">=</span> ennreal <span class="free">p</span> <span class="main">*</span>
    emeasure <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  bernoulli
            bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="bound">w</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> ennreal <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_component_probability<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
            bernoulli
            p_gt_0
            p_lt_1
            snth.simps<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> snth.simps<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span>  bernoulli
            bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> semi_goal_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span><span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> 
<span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">*</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="free">target</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> sets <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="main">⟹</span>
  emeasure <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> emeasure <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span> <span class="main">∂</span><span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emeasure_stream_space
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Collect_cong nn_integral_cong prob_space.emeasure_stream_space prob_space_measure_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  conditional_set_equation_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
            assms
            bernoulli_stream_space<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
            bernoulli
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> success_measurable_shd_false
            success_measurable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
            assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span>  bernoulli
             bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="bound">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span>
       <span class="main">∂</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
    ennreal <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">≠</span> top"</span></span>
        <span class="keyword1"><span class="command">using</span></span> emeasure_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
              success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span><span class="main">]</span>
              bernoulli
              bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="bound">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span>
          emeasure <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">*</span>
          <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> True <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> False <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fun_description_pre_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span> <span class="main">_</span><span class="main">]</span> assms
              bernoulli
              bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
              mult.commute 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> semi_goal2_final_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span>
<span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span> <span class="free">target</span><span class="main">}</span>"</span></span> 
<span class="quoted"><span class="quoted">"measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">)</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span><span class="main">}</span>"</span></span><span class="main">]</span>   
            p_gt_0 p_lt_1
            bernoulli
            bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>stream_space <span class="var">?M</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>stl <span class="bound">x</span><span class="main">)</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> 
<span class="main">=</span> ennreal <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p</span><span class="main">)</span> <span class="main">*</span>
    emeasure <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>stream_space <span class="main">(</span>measure_pmf <span class="main">(</span>bernoulli_pmf <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  bernoulli
            bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span><span class="main">-</span><span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">w</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_component_probability_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
            bernoulli
            p_gt_0
            p_lt_1
            snth.simps<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> snth.simps<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span>  bernoulli
            bernoulli_stream_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Final goal: establish the recursive probability equation›</span></span>


  <span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The final probability equation we want to formalize: $$P_n = pP_{n+1} + (1-p)P_{n-1}$$›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Recursive_probability_equation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="free">target</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">init</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">&lt;</span> <span class="free">target</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span><span class="quoted"><span class="quoted">"probability_of_win <span class="free">init</span> <span class="free">target</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span>probability_of_win <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">target</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>probability_of_win <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">target</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> probability_of_win.simps
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>
 <span class="main">=</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span> 
<span class="main">+</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> success_measurable_shd_false
            success_measurable_shd
            success_measurable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
            assms
            Sigma_Algebra.sets.Int
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">∈</span> sets <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> success_measurable_shd_false
            success_measurable_shd
            success_measurable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
            assms
            Sigma_Algebra.sets.Int
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> emeasure_Un_Int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">M</span></span>  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span><span class="main">(</span>shd <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.commute plus_emeasure<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> 
emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">*</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> semi_goal_true<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          conditional_set_equation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> Collect_cong mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span> <span class="main">∧</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> 
emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">*</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> semi_goal_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          conditional_set_equation_false<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">target</span></span><span class="main">]</span>
          assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> Collect_cong mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span><span class="main">-</span><span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">w</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_component_probability_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
          bernoulli
          p_gt_0
          p_lt_1
          snth.simps<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snth.simps<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> shd <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> <span class="bound">w</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> ennreal <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bernoulli_stream_component_probability<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
          bernoulli
          p_gt_0
          p_lt_1
          snth.simps<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snth.simps<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="free">init</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">=</span>
  ennreal <span class="free">p</span> <span class="main">*</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span> <span class="main">+</span>
  ennreal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> emeasure <span class="free">M</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="free">M</span><span class="main">.</span> success <span class="main">(</span><span class="free">init</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">x</span> <span class="free">target</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>